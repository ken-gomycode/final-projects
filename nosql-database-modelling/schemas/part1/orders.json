{
  "$jsonSchema": {
    "bsonType": "object",
    "required": ["orderNumber", "customer", "items", "totals", "payment", "delivery", "createdAt", "updatedAt"],
    "properties": {
      "_id": {
        "bsonType": "objectId"
      },
      "orderNumber": {
        "bsonType": "string",
        "description": "Human-readable order reference"
      },
      "customer": {
        "bsonType": "object",
        "required": ["userId", "email", "name"],
        "properties": {
          "userId": {
            "bsonType": "objectId",
            "description": "Reference to the users collection"
          },
          "email": {
            "bsonType": "string"
          },
          "name": {
            "bsonType": "string",
            "description": "Full name snapshot at time of order"
          }
        },
        "description": "Denormalized customer snapshot"
      },
      "items": {
        "bsonType": "array",
        "minItems": 1,
        "items": {
          "bsonType": "object",
          "required": ["productId", "sku", "name", "price", "quantity", "subtotal"],
          "properties": {
            "productId": { "bsonType": "objectId" },
            "sku": { "bsonType": "string" },
            "name": { "bsonType": "string" },
            "price": { "bsonType": "double", "minimum": 0 },
            "quantity": { "bsonType": "int", "minimum": 1 },
            "subtotal": { "bsonType": "double", "minimum": 0 }
          }
        },
        "description": "Line items with point-in-time product snapshots"
      },
      "totals": {
        "bsonType": "object",
        "required": ["subtotal", "tax", "shipping", "total"],
        "properties": {
          "subtotal": { "bsonType": "double", "minimum": 0 },
          "tax": { "bsonType": "double", "minimum": 0 },
          "shipping": { "bsonType": "double", "minimum": 0 },
          "total": { "bsonType": "double", "minimum": 0 }
        }
      },
      "payment": {
        "bsonType": "object",
        "required": ["method", "status"],
        "properties": {
          "method": {
            "bsonType": "string",
            "enum": ["card", "bank_transfer", "wallet"]
          },
          "status": {
            "bsonType": "string",
            "enum": ["pending", "captured", "failed", "refunded"]
          }
        }
      },
      "delivery": {
        "bsonType": "object",
        "required": ["status", "address", "history"],
        "properties": {
          "status": {
            "bsonType": "string",
            "enum": ["pending", "processing", "shipped", "delivered", "returned"],
            "description": "Current delivery status"
          },
          "address": {
            "bsonType": "object",
            "properties": {
              "street": { "bsonType": "string" },
              "city": { "bsonType": "string" },
              "state": { "bsonType": "string" },
              "zip": { "bsonType": "string" },
              "country": { "bsonType": "string" }
            }
          },
          "history": {
            "bsonType": "array",
            "items": {
              "bsonType": "object",
              "required": ["status", "timestamp"],
              "properties": {
                "status": { "bsonType": "string" },
                "timestamp": { "bsonType": "date" }
              }
            },
            "description": "Append-only status transition log"
          }
        }
      },
      "createdAt": {
        "bsonType": "date"
      },
      "updatedAt": {
        "bsonType": "date"
      }
    },
    "additionalProperties": false
  },
  "indexes": [
    { "key": { "customer.userId": 1, "createdAt": -1 } },
    { "key": { "orderNumber": 1 }, "unique": true },
    { "key": { "delivery.status": 1 } },
    { "key": { "createdAt": -1 } }
  ],
  "writeConcern": { "w": "majority", "j": true },
  "readConcern": { "level": "majority" }
}
